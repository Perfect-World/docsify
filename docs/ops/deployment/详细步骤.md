### 服务器信息

```bash
sh /yykj/environment/sh/create_path.sh
sh /yykj/environment/sh/server_info.sh
```

### 安装docker

```bash
# 创建docker目录
sudo mkdir -p /yykj/environment/docker/docker
# 解压docker安装包
sudo tar -zxf /yykj/environment/docker/docker-29.1.2.tar.gz -C /yykj/environment/docker/docker
# 将解压后的 docker 文件移到 /usr/bin 目录下
sudo cp /yykj/environment/docker/docker/* /usr/bin/
# 将 docker 注册成系统服务 
sudo cp /yykj/environment/docker/docker.service /etc/systemd/system/docker.service
# 增加可执行权限
sudo chmod +x /etc/systemd/system/docker.service
# 重载系统服务
sudo systemctl daemon-reload 
# 设置 docker 开机自启动
sudo systemctl enable docker.service
# 启动 docker 服务
sudo systemctl start docker
# 测试 docker 是否启动成功
sudo systemctl status docker
```

### 安装docker镜像

```bash
# 导入docker镜像
sudo docker load -i /yykj/environment/docker-images/mysql_8.2.tar;
sudo docker load -i /yykj/environment/docker-images/jdk_21.tar;
sudo docker load -i /yykj/environment/docker-images/nginx_1.22.tar;
sudo docker load -i /yykj/environment/docker-images/git_latest.tar;
sudo docker load -i /yykj/environment/docker-images/maven_3.9.11.tar;
sudo docker load -i /yykj/environment/docker-images/node_24.12.tar;
# 查看docker镜像
sudo docker images;
```

### 拉取源码

```bash
# 前端、后台、vue
docker run --rm --user root --name git_scsmp_vue --entrypoint /bin/sh \
  -v /yykj/environment/git-config/.ssh:/root/.ssh \
  -v /yykj/project/scsmp-vue/code:/code \
  -w /code \
  -d alpine/git:latest \
  -c "
    if [ -d \"/code/.git\" ]; then
      GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git pull;
    else
      GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git clone git@codeup.aliyun.com:66f0fd3f79b7fe080f32787e/zhxa/scsmp-vue.git .;
    fi
  ";
# 前端、小程序、h5
docker run --rm --user root --name git_scsmp_h5 --entrypoint /bin/sh \
  -v /yykj/environment/git-config/.ssh:/root/.ssh \
  -v /yykj/project/scsmp-h5/code:/code \
  -w /code \
  alpine/git:latest \
  -c "
    if [ -d \"/code/.git\" ]; then
      GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git pull;
    else
      GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git clone git@codeup.aliyun.com:66f0fd3f79b7fe080f32787e/zhxa/scsmp-app.git .;
    fi
  ";
# 后端、java
docker run --rm --user root --name git_scsmp_java --entrypoint /bin/sh \
  -v /yykj/environment/git-config/.ssh:/root/.ssh \
  -v /yykj/project/scsmp-java/code:/code \
  -w /code \
  alpine/git:latest \
  -c "
    if [ -d \"/code/.git\" ]; then
      GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git pull;
    else
      GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git clone git@codeup.aliyun.com:66f0fd3f79b7fe080f32787e/zhxa/scsmp-admin.git .;
    fi
  ";
```

### node编译/打包

```bash
############ vue ############
# node编译前备份
tar -zcf /yykj/backup/vue/scsmp_vue/dist_$(date +"%Y%m%d_%H%M%S").tar.gz -C /yykj/project/scsmp-vue/dist .
# node编译vue源码
docker run -it --rm --user root --name node_scsmp_vue --entrypoint /bin/sh \
  -v /yykj/project/scsmp-vue/code:/code \
  -v /yykj/project/scsmp-vue/code/node_modules:/code/node_modules \
  -v /yykj/environment/node/repositories:/etc/apk/repositories \
  node:24.12.0-alpine \
  -c "
    apk add --no-cache libc6-compat git && \
    cd /code && \
    npm config set registry https://registry.npmmirror.com && \
    npm install && \
    npm run build
    ";
# 移动
rm -rf /yykj/project/scsmp-vue/dist/*
mv /yykj/project/scsmp-vue/code/dist/* /yykj/project/scsmp-vue/dist
############ h5 ############
# node编译前备份
tar -zcf /yykj/backup/h5/scsmp_h5/dist_$(date +"%Y%m%d_%H%M%S").tar.gz -C /yykj/project/scsmp-h5/dist .
# node编译vue源码
docker run -it --rm --user root --name node_scsmp_h5 --entrypoint /bin/sh \
  -v /yykj/project/scsmp-h5/code:/code \
  -v /yykj/environment/node/repositories:/etc/apk/repositories \
  node:24.12.0-alpine \
  -c "
    apk add --no-cache libc6-compat git && \
    cd /code && \
    npm config set registry https://registry.npmmirror.com && \
    npm install && \
    npm run build
    ";
# 移动
rm -rf /yykj/project/scsmp-h5/dist/*
mv /yykj/project/scsmp-h5/code/dist/* /yykj/project/scsmp-h5/dist
```

### maven编译/打包

```bash

# 导出主依赖+插件依赖（SpringBoot打包依赖插件），包含传递依赖，同时导出pom文件
mvn clean dependency:copy-dependencies dependency:resolve-plugins -DoutputDirectory=/mydata/maven/maven-deps  -DincludeScope=runtime -Dtransitive=true -DcopyPom=true -DexcludeTypes=pom

tar -zcf /mydata/maven/maven-jar.tar.gz /mydata/java/maven-jar
tar -zxf /mydata/maven/maven-jar.tar.gz -C /mydata/maven/maven-jar
mv /mydata/maven/maven-jar/mydata/java/maven-jar/* /mydata/maven/maven-jar
rm -rf /mydata/maven/maven-jar/mydata

# maven编译java源码
docker maven 3.9.11-amazoncorretto-21-debian
源码/mydata/git/code
仓库/mydata/maven/maven-jar
docker run -it --rm \
  --user root \
  --name maven_scsmp_java \
  --entrypoint /bin/sh \
  -v /mydata/git/code:/code \
  -v /mydata/maven/maven-jar:/root/.m2/repository \
  maven:3.9.11-amazoncorretto-21-debian \
  -c "cd /code && mvn clean package -DskipTests";
  
```

### 安装mysql

```bash
# 启动 mysql 容器
docker run \
--name mysql8.2 \
--restart unless-stopped \
-e TZ=Asia/Shanghai \
-e MYSQL_ROOT_PASSWORD=zhao_new@sina.com863 \
-e MYSQL_USER=wencong \
-e MYSQL_PASSWORD=wencong863 \
-v /yykj/environment/mysql-config/logs:/var/log/mysql \
-v /yykj/environment/mysql-config/data:/var/lib/mysql \
-v /yykj/environment/mysql-config/conf:/etc/mysql/conf.d \
-v /yykj/environment/mysql-config/sqls:/tmp \
-p 0.0.0.0:50105:3306 \
-d mysql:8.2;
# 创建数据库 新账号 赋权，限制账号对应操作数据库权限
docker exec -it mysql8.2 /bin/bash
mysql -uroot -P3306 -p
	# 输入密码 zhao_new@sina.com863
create database scsmp_admin;
create user 'yykj'@'%' identified by 'Hh6@yykj';
grant all privileges ON *.* TO 'yykj'@'%'; 
flush privileges;
show grants for 'yykj'@'%';
# 迁移数据库
mysqldump -uroot -P3306 -p scsmp > /yykj/environment/mysql-config/sqls/scsmp_$(date +"%Y%m%d").sql
# Hh6@yykj
docker exec mysql8.2 sh -c "mysql -uyykj -P3306 -pHh6@yykj scsmp_admin < /tmp/scsmp_$(date +'%Y%m%d').sql"

```

### 启动java

```bash
# 启动后端服务
sh /yykj/project/scsmp-java/deploy_scsmp_java.sh ywgsprodlinux6
# docker stop scsmp_admin_java && docker rm scsmp_admin_java
```

### 启动vue

```bash
docker run \
--user root \
--name scsmp_vue \
--restart unless-stopped \
-e TZ=Asia/Shanghai \
-p 0.0.0.0:50106:10001 \
-v /mydata/project/scsmp-vue/conf:/etc/nginx \
-v /mydata/project/scsmp-vue/dist:/usr/share/nginx \
-v /mydata/project/scsmp-vue/logs:/var/log/nginx \
-v /mydata/project/scsmp-java/files:/var/files \
-v /etc/localtime:/etc/localtime \
-d nginx:1.22;

```

### 启动h5

```bash

docker run \
--user root \
--name scsmp_h5 \
--restart unless-stopped \
-e TZ=Asia/Shanghai \
-p 0.0.0.0:50107:10001 \
-v /mydata/project/scsmp-h5/conf:/etc/nginx \
-v /mydata/project/scsmp-h5/dist:/usr/share/nginx \
-v /mydata/project/scsmp-h5/logs:/var/log/nginx \
-v /mydata/project/scsmp-java/files:/var/files \
-v /etc/localtime:/etc/localtime \
-d nginx:1.22;
```

